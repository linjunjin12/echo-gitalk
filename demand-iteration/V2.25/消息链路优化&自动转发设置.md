[]

## 1. 消息链路处理-技术优化

**现状**：用户发送一条消息，基石都会往新、旧链路推送消息，两边都会走nlp解析，记录解析结果。一定程度上加大了nlp解析的压力。

**优化**：消息链路处理，灰度机构走新消息链路、非灰度机构走旧消息链路。去除原先灰度与否都走`nlp`并记录解析结果。

**修改点**：

- 指导/投标/中标结果 私聊前置解析：判断分组是否灰度

- 指导/投标/中标结果 群聊前置解析：判断 `nacos` 是否开启群聊灰度





## 2. 

### 2.1 配置的查询与配置

#### 2.1.1 指导/发行结果解析设置

**新增私聊是否解析设置**（默认选中全部私聊）

- 存储：复用 `t_user_guide_config`，新增 `type` = `5` ; `value` = `51`- 开启；`52 `- 关闭
- 设置接口：在保存指导相关设置接口新增字段
  - `GuidanceSettingParam`
- 查询接口：在查询指导配置接口新增字段
- 私聊前置解析修改：查询该设置是否选中，没选中则不往后执行



#### 2.1.2 来源群成员设置

**转发来源为群的历史数据处理**：json结构修改

```java
// 原数据
// ["12334","1112123"]
// 新数据默认选中群内全部人员
// ["12334":["all"], "1112123":["all"]]
// 用户修改群内的人员时
// ["12334":["abc","def"], "1112123":["all"]]
```

**保存设置**：

- 在保存自动转发接口新增两个参数 替换 原转发来源群id集合字段

```java

// groupId -> openIds
// 指导/发行结果转发来源参数
Map<String, List<String>> guideForwardSourceGroupIdMap;

// 纯文本消息转发
Map<String, List<String>> textForwardSourceGroupIdMap;
```

- 同步给基石自动转发规则修改
  - 群里面设置转发的部分人员 --- 基石接口是否支持==待确认==？

**查询设置**：

​	新增查询群设置的人员接口

​	新增查询基石转发规则群设置的人员接口



**反向同步群白名单**

选中的QT群若不在“指导/发行结果解析设置”弹窗中的“解析来源”选中群中，则在保存后自动将该QT群加入到“解析来源”群名单中



#### 2.1.3 禁转关键词设置

**数据表新增类型**

- 新增Ftype=7

**保存配置**

- 在保存自动转发接口新增一个字段

```java
// 禁转关键词
private String ForwardingProhibitioPWords;
```

- 关键词规则校验：

  - 单个关键词最多支持录入20个汉字；

  - 最多支持输入10个关键词，若超过10个关键词，提示：设置的关键词不能超过10个；

**查询配置**

新增返回字段



#### 2.1.4 转发时间设置

**数据表新增类型**

- 新增Ftype=8

**保存配置**

- 在保存自动转发接口新增两个字段

  ```java
  private String startTime;
  private String endTime;
  
  ```

**查询配置**

新增返回字段



### 2.2 自动转发应用配置规则修改	

#### 2.2.1 指导/发行结果转发群来源过滤

- 判断消息发送人是否在群来源配置的全部或者选中状态

#### 2.2.2 禁转关键词过滤

- 判断消息内容是否包含任意一个关键词
  - 包含：不转发
  - 不包含：转发

#### 2.2.3 转发时间过滤

- 开始、结束时间都为空，不进行过滤
- 判断当前时间是否在[startTime, endTime] 左闭右闭区间里面
  - 在：转发
  - 不在：不转发