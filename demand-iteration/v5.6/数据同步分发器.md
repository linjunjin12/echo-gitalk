

# 一、数据同步分发器

> 提供通用的数据同步框架，业务方引入 `client` 端，进行少量的配置，即可完成变更数据的实时推送

## 1. 框架特性
1. 数据同步==通用化==，无需再对每张表写数据同步切面逻辑
1. 较大程度减少反查 `mysql` 数据次数
2. 基于 `Netty` 进行数据的==实时==推送
3. 业务方对变更的数据进行本地 `JVM` 缓存，对热点数据的访问，可提供==高性能==服务
## 2. 系统架构图
![架构图](../../_media/V5.6/系统架构图.png ':size=50%')

## 3. `MybatisPlus` 数据变更插件
 ![数据变更插件](../../_media/V5.6/获取变更数据通用插件.png ':size=50%')
### 3.1 说明
!>  注意：插件不会进行数据反查，不能使用 `mysql` 自带函数

- 表的 `createTime` 和 `updateTime` 取 `select now();` 需要实际精确的字段值，在业务方自行查询

- 更新场景尽量使用占位符的方式进行更新，设置固定值只支持与字段类型匹配的值及null，不兼容的场景会抛异常

## 4. 客户端与服务端交互时序图
![数据同步分发时序图](../../_media/V5.6/数据同步分发时序图.png ':size=50%')
## 5. 数据报文

```java
@Data
public class BaseMessage implements Serializable {
    private String requestId;

    private String msgId;

    /**
     * 心跳消息
     * 应用名-channel绑定消息
     * 业务数据消息
     */
    private Enum<?> msgType;

}

@EqualsAndHashCode(callSuper = true)
@Data
public class DataSyncMessage extends BaseMessage implements Serializable {

    /**
     * currentAppName -> receiveAppName
     */
    private Map<String, List<String>> routingAppNameMap;

    /**
     * 实时变更数据
     */
    private Map<SqlCommonType, ChangeDataDTO> changeDataMap;
}

public enum SqlCommonType {
    INSERT, UPDATE, DELETE
}

@Data
@SuppressWarnings("all")
public class ChangeDataDTO implements Serializable {

    /**
     * 数据变更类型
     */
    private SqlCommonType sqlCommonType;

    /**
     * 表 -> 主键 -> 行
     */
    private Map<Class<?>, Map<String, Object>> masterTableData;

    /**
     * 主表 -> 子表 -> 主表主键 -> 子表数据集合
     */
    private Map<Class<?>, Map<Class<?>, Map<String, List>>> slaveTableData;

    /**
     *  表 -> 主键 -> 空值属性集合
     */
    private Map<Class<?>, Map<String, List<String>>> updateNullFileds;
  
  	/**
  	 * 附加数据
  	 */
  	private Map<String, Object> extraMap;

}
```

