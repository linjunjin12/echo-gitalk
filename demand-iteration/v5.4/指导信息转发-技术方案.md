

# 指导/发行结果解析转发与自动转发

## 1. `nlp` 接口调用流程

### 1.1 不同入口调用 `nlp` 流程图
![不同入口调用nlp流程](../../_media/V5.4/不同入口调用nlp流程.png ':size=50%' )

### 1.2 代码改动点
新增 `controller` 接口，详见：[nlp解析接口](#nlp-parse)

## 2. 载入时解析预览

### 2.1 流程图
![载入内容及解析预览流程](../../_media/V5.4/载入内容及解析预览流程.png ':size=50%')

### 2.2 代码改动点
修改查询发送详情接口，详见：[获取发送详情接口](#send-details)

## 3. 修改文本内容解析预览

### 3.1 流程图
![修改时解析预览流程](../../_media/V5.4/修改时解析预览流程.png ':size=50%')
### 3.2 代码改动点

复用 `nlp` 解析接口，详见：[nlp解析接口](#nlp-parse)

## 4. 修改模板后解析预览

### 4.1 流程图
![修改模板流程图](../../_media/V5.4/修改模板流程图.png ':size=50%')

### 4.2 代码改动点
修改内容填充接口，详见：[根据选中的模板获取群发信息](#chat-content)

## 5. 确认发送

### 5.1 流程图
![确认发送](../../_media/V5.4/确认发送.png ':no-zoom')


### 5.2 代码改动点

修改确认发送接口，详见：[确认发送](#group-send)



## 6. 自动转发

### 6.1 配置项

​	首发后自动发送配置，复用 `t_user_guide_config` 表，新增类型如下：

| 字段     | 值   | 说明               |
| -------- | ---- | ------------------ |
| `Ftype`  | `3`  | 首发后自动发送配置 |
| `Fvalue` | `31` | 关闭自动转发       |
| `Fvalue` | `32` | 开启自动转发       |

### 6.2 新增首发记录表
!> 不区分指导/发行结果，相同 `Fbond_id` 会进行覆盖

```sql
CREATE TABLE db_primary_bond_sale.`t_nlp_guidance_first_round_record` (
  `Fid` bigint(21) unsigned NOT NULL AUTO_INCREMENT COMMENT '自增id',
  `Fbond_id` bigint(21) NOT NULL COMMENT '关联债券Id',
  `Fopen_id` varchar(64) NOT NULL COMMENT '发送方openId',
	`Ftenant_id` bigint(19) unsigned NOT NULL COMMENT '分组id',
	`Freceive_open_ids` MEDIUMTEXT NOT NULL COMMENT '接收方openIds(数组格式)',
  `Fcreate_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `Fupdate_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`Fid`),
  UNIQUE KEY `idx_open_id_bond_id` (`Fopen_id`, `Fbond_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='指导/发信结果首发记录表';
```

### 6.3 流程图
![自动转发](../../_media/V5.4/自动转发.png ':no-zoom' )

## 7. 解析转发

### 7.1 流程图
![解析转发](../../_media/V5.4/解析转发流程图.png ':no-zoom')

### 7.2 代码改动点

`MQ` 发送者：在确认发送逻辑里

`MQ`消费者：`chat-parse` 服务新增消费者处理

## 8. 前端交互接口说明

### 8.1 nlp解析接口 :id=nlp-parse

- 请求地址

  | URL                                        | METHOD |
    | ------------------------------------------ | ------ |
  | /primary_bond_sale/bond_guidance/nlp/parse | post   |

- 请求参数

  | 请求参数 | 参数类型 | 参数说明             |
    | -------- | -------- | -------------------- |
  | content  | String   | 解析内容             |
  | sendType | Integer  | 发送入口（11个入口） |

- 响应参数

  | 响应参数           | 参数类型 | 参数说明                                                     |
    | ------------------ | -------- | ------------------------------------------------------------ |
  | nlpParseResultJson | String   | 返回nlp解析完整json数据，确认发送时需要回传该参数，有可能为空 |
  | parsePreviewList   | Array    | 解析预览数据                                                 |

- 示例

  ```json
  {
    "msg": "ok",
    "code": 0,
    "data": {
      nlpParseResultJson: "",
      parsePreviewList: []
    }
  }
  ```



### 8.2 获取发送详情接口 :id=send-details

- 请求地址

  | URL                                           | METHOD |
    | --------------------------------------------- | ------ |
  | /primary_bond_sale/bond_guidance/send_details | post   |

- 新增响应参数

  | 响应参数           | 参数类型 | 参数说明                                                     |
    | ------------------ | -------- | ------------------------------------------------------------ |
  | nlpParseResultJson | String   | 返回nlp解析完整json数据，确认发送时需要回传该参数，有可能为空 |
  | parsePreviewList   | Array    | 解析预览数据                                                 |

- 示例

  ```json
  {
    "msg": "ok",
    "code": 0,
    "data": {
      nlpParseResultJson: "",
      parsePreviewList: []
    }
  }
  ```



### 8.3 根据选中的模板获取群发信息 :id=chat-content

- 请求地址

  | URL                                          | METHOD |
    | -------------------------------------------- | ------ |
  | /primary_bond_sale/bond_guidance/chatContent | Get    |

- 新增响应参数

  | 响应参数           | 参数类型 | 参数说明                                                     |
    | ------------------ | -------- | ------------------------------------------------------------ |
  | nlpParseResultJson | String   | 返回nlp解析完整json数据，确认发送时需要回传该参数，有可能为空 |
  | parsePreviewList   | Array    | 解析预览数据                                                 |

- 示例

  ```json
  {
    "msg": "ok",
    "code": 0,
    "data": {
      nlpParseResultJson: "",
      parsePreviewList: []
    }
  }
  ```



### 8.4 确认发送接口 :id=group-send

- 请求地址

  | URL                                         | METHOD |
    | ------------------------------------------- | ------ |
  | /primary_bond_sale/bond_guidance/group_send | post   |

- 请求参数

  | 请求参数           | 参数类型 | 参数说明                            |
  | ------------------ | -------- | ----------------------------------- |
  | nlpParseResultJson | String   | 前端回传的参数，nlp解析完整json数据 |

- 示例

  ```json
  {
    "msg": "ok",
    "code": 0,
    "data": null
  }
  ```





